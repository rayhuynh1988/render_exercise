<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <main class="container">
        <!-- Navbar -->
        <%- include('../partials/navbar'); %>

        <!-- Welcome Section -->
        <div class="welcome-container">
            <h1>Welcome to the Restaurant Guide</h1>
            <h2>Explore top-rated restaurants!</h2>
        </div>

        <!-- Filter Section -->
        <div class="filter-container">
            <label for="filter-cuisine">Cuisine:</label>
            <input type="text" id="filter-cuisine" placeholder="e.g., French">
            
            <label for="filter-location">Location:</label>
            <input type="text" id="filter-location" placeholder="e.g., Chinatown">
            
            <label for="filter-rating">Minimum Rating:</label>
            <input type="number" id="filter-rating" min="1" max="5" step="0.1" placeholder="e.g., 4.5">
        </div>

        <!-- Restaurant Data -->
        <div id="restaurant-list">
            <% blogs.forEach(restaurant => { %>
                <article class="post-container" 
                         data-cuisine="<%= restaurant.cuisine.toLowerCase() %>" 
                         data-location="<%= restaurant.location.toLowerCase() %>" 
                         data-rating="<%= restaurant.rating %>" 
                         data-visits="0" 
                         id="restaurant-<%= restaurant.id %>">
                    <h3><%= restaurant.name %></h3>
                    <p><strong>Cuisine:</strong> <%= restaurant.cuisine %></p>
                    <p><strong>Price Range:</strong> <%= restaurant.price %></p>
                    <p><strong>Location:</strong> <%= restaurant.location %></p>
                    <p><strong>Rating:</strong> <%= restaurant.rating %> / 5</p>
                    <p><strong>Dietary Option:</strong> <%= restaurant.diet %></p>
                    <p><strong>Visits:</strong> <span class="visit-count">0</span></p>
                    <button class="button visit-btn">Visited</button>
                    <form action="/delete/<%= restaurant.id %>" method="post" onsubmit="return confirm('Do you really want to delete this restaurant?');">
                        <button class="outline primary" type="submit">Delete</button>
                    </form>
                </article>
            <% }); %>
        </div>
    </main>

    <!-- JavaScript for Filtering and Ranking -->
    <script>
        const cuisineFilter = document.getElementById('filter-cuisine');
        const locationFilter = document.getElementById('filter-location');
        const ratingFilter = document.getElementById('filter-rating');
        const restaurantList = document.getElementById('restaurant-list');
        const restaurants = Array.from(restaurantList.querySelectorAll('.post-container'));

        function filterRestaurants() {
            const cuisineValue = cuisineFilter.value.toLowerCase();
            const locationValue = locationFilter.value.toLowerCase();
            const ratingValue = parseFloat(ratingFilter.value) || 0;

            restaurants.forEach(restaurant => {
                const matchesCuisine = restaurant.dataset.cuisine.includes(cuisineValue);
                const matchesLocation = restaurant.dataset.location.includes(locationValue);
                const matchesRating = parseFloat(restaurant.dataset.rating) >= ratingValue;

                if (matchesCuisine && matchesLocation && matchesRating) {
                    restaurant.style.display = '';
                } else {
                    restaurant.style.display = 'none';
                }
            });
        }

        function sortRestaurants() {
            restaurants.sort((a, b) => {
                const visitsA = parseInt(a.dataset.visits);
                const visitsB = parseInt(b.dataset.visits);
                const ratingA = parseFloat(a.dataset.rating);
                const ratingB = parseFloat(b.dataset.rating);

                if (visitsB === visitsA) {
                    return ratingB - ratingA; // Secondary sort by rating
                }
                return visitsB - visitsA; // Primary sort by visits
            });

            restaurants.forEach(restaurant => {
                restaurantList.appendChild(restaurant); // Reorder the DOM elements
            });
        }

        document.querySelectorAll('.visit-btn').forEach(button => {
            button.addEventListener('click', function () {
                const restaurant = button.closest('.post-container');
                const visitCountElem = restaurant.querySelector('.visit-count');
                let visitCount = parseInt(restaurant.dataset.visits) || 0;

                visitCount += 1; // Increment visits
                restaurant.dataset.visits = visitCount;
                visitCountElem.textContent = visitCount;

                sortRestaurants(); // Re-sort restaurants after updating visits
            });
        });

        cuisineFilter.addEventListener('input', filterRestaurants);
        locationFilter.addEventListener('input', filterRestaurants);
        ratingFilter.addEventListener('input', filterRestaurants);
    </script>
</body>
</html>
